# Сети в Linux

Настройка сетей в Linux на виртуальных машинах.

## Contents
1 [Инструмент ipcalc](#part-1-инструмент-ipcalc) \
2 [Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами) \
3 [Утилита iperf3](#part-3-утилита-iperf3) \
4 [Сетевой экран](#part-4-сетевой-экран) \
5 [Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети) \
6 [Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp) \
7 [NAT](#part-7-nat) \
8 [Допополнительно. Знакомство с SSH Tunnels](#part-8-дополнительно-знакомство-с-ssh-tunnels)

## Part 1. Инструмент **ipcalc**

* Установим утилиту ipcalc на пк
```bash
sudo apt intall ipcalc
```

### Сети и маски
* аддресс сети 192.167.38.54/13

![address](img/1.png "address of 192.167.38.54/13") 

* Перфиксана и двоичная запись маски 255.255.255.0

![prefix_and_binary](img/2.png "prefix_and_binary of 255.255.255.0")

* Двоичная и обчная запись /15
  
![binary_and_basic](img/3.png "binary_and_basic of /15")

* Постфиксная и обычная запись для 11111111.11111111.11111111.11110000

![basic_and_postifx](img/4.png "basic_and_postifx of 11111111.11111111.11111111.11110000")

* Мимнимальный и максимальный хочт сети 12.167.38.4 при маске /8
  
![min_max_/8](img/5.png "min_max host with /8")

* Мимнимальный и максимальный хочт сети 12.167.38.4 при маске 11111111.11111111.00000000.00000000

![min_max_binary](img/6.png "min_max host with binary")

* Мимнимальный и максимальный хочт сети 12.167.38.4 при маске 255.255.254.0

![min_max_basic](img/7.png "min_max host with basic")

* Мимнимальный и максимальный хочт сети 12.167.38.4 при маске /4

![min_max_/4](img/8.png "min_max host with /4")

### Localhost

* К приложению, работающему на localhost можно обратиться с: 127.0.0.2, 127.1.0.1

* Нельзя обратиться с: 194.34.23.100, 128.0.0.1

### Диапазоны и сегменты сетей

* IP адреса, которые можно использовать в качестве частных: 10.0.0.45, 172.20.250.4, 192.168.4.2, 172.16.255.255, 10.10.10.10 - частные. 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1 - публичные.
* IP адреса, возможные у сети 10.10.0.0/18: 10.10.0.2, 10.10.10.10, 10.10.1.255 Невозможные: 10.0.0.1, 10.10.100.1

## Part 2. Статическая маршрутизация между двумя машинами

### С помощью команды `ip a` посмотреть существующие сетевые интерфейсы

![ip_a](img/9.png "ip_a")

* Сетевые конфигурации в etc/netplan/00-installer-config.yaml

![ip_config](img/10.png "ip_config")

* Применяем netplan apply

![netplan_apply](img/11.png "netplan_apply")

### Добавление статического маршрута вручную

* Применяем ip r add на обоих машинах и пингуем одну и другую

![static_rout](img/12.png "static_rout")

### Добавление статического маршрута с сохранением
* Добавляем маршруты от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml

![ip_config](img/13.png "ip_config")

* Затем применяем настройки netplan apply и пингуем машины

![netplan_apply](img/14.png "netplan_apply")

## Part 3. Утилита **iperf3**

### Скорость соединения
* 8Mbps --> 1MB/s 100MB/s --> 819200Kbps 1Gbps --> 1024Mbps

### 3.2. Утилита **iperf3**
* Запускаем и замеряем скорость

![netplan_iperf3](img/15.png "netplan_iperf3")

## Part 4. Сетевой экран
### Утилита **iptables**
* Делаем концигурационне файлы для фаервола на двух машинах в */etc/firewall.sh*

![firewall_config](img/16.png "firewall_config")

* Применяем настройки и пингуем машины

![firewall_ping](img/17.png "firewall_ping")

* Правила выполняться сверху-вниз, следовательно, если правило запрета находиться выше оно срабатывает, а правило разрешения находящиеся ниже нет.
### Утилита **nmap**

* Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен.

![nmap](img/18.png "nmap")

## Part 5. Статическая маршрутизация сети
### Настройка адресов машин
* Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.
![net_set](img/19.png "net_set")
* Проверяем адреса
![net_check](img/20.png "net_check")
* Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
![net_ping](img/21.png "net_ping")
![net_ping](img/22.png "net_ping")

### Включение переадресации IP-адресов.
* Для включения переадресации IP, выполните команду на роутерах: `sysctl -w net.ipv4.ip_forward=1`
![forward_apply](img/23.png "forward_apply")
* Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку: `net.ipv4.ip_forward = 1`
![forward_apply](img/24.png "forward_apply")

### Установка маршрута по-умолчанию
* Настроить маршрут по-умолчанию (шлюз) для рабочих станций.
![net_config](img/25.png "net_config")
* Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации
![net_config](img/26.png "net_config")
* Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i eth1`
![net_ping](img/27.png "net_ping")
![net_ping](img/28.png "net_ping")

### Добавление статических маршрутов
* Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:
![router_config](img/29.png "router_config")
* Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах.
![router_config](img/30.png "router_config")
* Запустить команды на ws11: `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`
![ip_r](img/31.png "ip_r")
* Для адреса 10.10.0.0/18 был выбран маршрут отличный от 0.0.0.0/0, потому что роутер всегда предпочитает выбирает ту маску что больше, а также поскольку он является адресом сети и доступен без шлюза.

### Построение списка маршрутизаторов
* Запустить на r1 команду дампа: `tcpdump -tnv -i eth0`
* При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
![ip_route](img/32.png "ip_route")
* Путь строиться от узла к узлу до того момента, покаа не будет достигнута конечная точка. Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. На каждом узле добавляется счетчик, который отслеживает количество пройденых узлов.

### Использование протокола **ICMP** при маршрутизации
* Запускаем на r1 перехват сетевого трафика, проходящего через enp0s8 с помощью команды tcpdump -tn -i <название интерфейса> и пропингуем с ws11 несуществующий IP 10.30.0.111 с помощью команды:
![ip_ping](img/33.png "ip_ping")

## Part 6. Динамическая настройка IP с помощью **DHCP**
* Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
![dhcpd](img/34.png "dhcpd")
* в файле *resolv.conf* прописать `nameserver 8.8.8.8.`
![dhcpd](img/35.png "dhcpd")
* Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес.
![dhcpd](img/36.png "dhcpd")
![dhcpd](img/37.png "dhcpd")
* Проверяем что машине ws21 выдали адрес
![dhcpd](img/38.png "dhcpd")
* Также пропинговать ws22 с ws21.
![dhcpd](img/39.png "dhcpd")
* Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`
![net_config](img/40.png "net_config")
* Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
![dhcpd](img/41.png "dhcpd")
![dhcpd](img/42.png "dhcpd")
![dhcpd](img/43.png "dhcpd")
![dhcpd](img/44.png "dhcpd")
* Запросить с ws21 обновление ip адреса
![new_adr](img/45.png "new_adr")
![new_adr](img/46.png "new_adr")
* sudo dhclient -r <интерфейс> -- освобождает текущий адрес интерфейса
* sudo dhclient -v (for verbose) <интерфейс> -- освобождает задает новый адрес

## Part 7. **NAT**
* В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным
![new_serv](img/47.png "new_serv")
* Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1
![new_serv](img/48.png "new_serv")
* Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2
* Добавляем фаэрвол со следуюшими правилами:
* Удаление правил в таблице filter - iptables -F
* даление правил в таблице "NAT" - iptables -F -t nat
* Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP
![new_serv](img/49.png "new_serv")
![new_serv](img/50.png "new_serv")
* Проверить соединение между ws22 и r1 командой `ping`
![new_serv](img/51.png "new_serv")
* Добавить в файл ещё одно правило:
![new_serv](img/52.png "new_serv")
* Проверить соединение между ws22 и r1 командой `ping`
![new_serv](img/53.png "new_serv")
* Добавить в файл ещё два правила:
![new_serv](img/54.png "new_serv")
* Проверяем
![new_serv](img/55.png "new_serv")
![new_serv](img/56.png "new_serv")

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**
